name: Build Alpine Image

on:
  push:
    branches:
      - master  # Trigger when pushing to master branch

jobs:
  build:
    runs-on: ubuntu-latest  # GitHub Actions runner

    steps:
      # Step 1: Checkout the code
      - name: Checkout repository
        uses: actions/checkout@v2

      # Step 2: Install necessary dependencies for the build machine (without X11)
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            qemu-user-static \
            curl \
            git \
            sudo \
            libssl-dev \
            build-essential \
            jq

      # Step 3: Make the script executable
      - name: Make scripts executable
        run: |
          chmod +x ./create_kindle_alpine_image.sh

      # Step 4: Run the bash script (with sudo if needed)
      - name: Run bash script to create Alpine image
        run: |
          sudo ./create_kindle_alpine_image.sh

      - name: Create zip file 
        run: sudo zip alpine.zip ./alpine.conf ./alpine.sh ./alpine.ext3

      - name: Create GitHub Release and Upload Zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # GitHub token to authenticate API request
        run: |
          FILE_NAME = "alpine$APKVER.zip" 
          echo "$FILE_NAME" 
          TAG_NAME="v$(date +'%Y.%m%d.%H%M%S')"  # Generate a version tag based on date-time
          git tag $TAG_NAME
          git push origin $TAG_NAME
          echo $TAG_NAME
          REPO="${{ github.repository }}" 
          echo "$REPO"
          echo "tag name is: $TAG_NAME" 
          RESPONSE=$(curl -s -X POST "https://api.github.com/repos/${REPO}/releases" \
            -H "Authorization: token $GITHUB_TOKEN" \
            -d @- <<EOF
          {
            "tag_name": "$TAG_NAME",
            "name": "$TAG_NAME"
          }
          EOF
          )

          echo "$RESPONSE" 

          UPLOAD_URL=$(echo "$RESPONSE" | jq -r .upload_url | sed -e 's/{?name,label}//')
          echo "$UPLOAD_URL" 

          # Upload the release asset (the zip file)
          curl -X POST --data-binary @$FILE_NAME \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Content-Type: application/zip" \
            "$UPLOAD_URL?name=$FILE_NAME"

