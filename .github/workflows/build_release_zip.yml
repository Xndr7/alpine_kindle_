name: Build Alpine Image

on:
  push:
    branches:
      - master  # Trigger when pushing to master branch

jobs:
  build:
    runs-on: ubuntu-latest  # GitHub Actions runner

    steps:
      # Step 1: Checkout the code
      - name: Checkout repository
        uses: actions/checkout@v2

      # Step 2: Install necessary dependencies for the build machine (without X11)
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            qemu-user-static \
            curl \
            git \
            sudo \
            libssl-dev \
            build-essential

      # Step 3: Make the script executable
      - name: Make scripts executable
        run: |
          chmod +x ./create_kindle_alpine_image.sh

      # Step 4: Run the bash script (with sudo if needed)
      - name: Run bash script to create Alpine image
        run: |
          sudo ./create_kindle_alpine_image.sh

      - name: Create zip file 
        run: sudo zip alpine.zip ./alpine.conf ./alpine.sh ./alpine.ext3

      - name: Create Git tag
        run: |
          TAG_NAME="v$(date +'%Y.%m.%d.%H%M%S')"  # Generate a version tag based on date-time
          git tag $TAG_NAME
          git push origin $TAG_NAME
          echo $TAG_NAME

      # Step 7: Create the release and upload the zip file
      - name: Create GitHub Release and Upload Zip
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.create_git_tag.outputs.tag_name }}  # Use the created tag as release version
          files: alpine.zip  # Upload the zip file as an asset
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}



  
